# .github/workflows/android-qt-build.yml

name: Build Android APK (Qt for Python)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-android-qt:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out code
    - name: Check out code
      uses: actions/checkout@v4

    # Step 2: Set up Java (Needed for Android SDK/Gradle)
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # Often required by modern Android Gradle Plugin

    # Step 3: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # Match PySide6 requirement/preference

    # Step 4: Install Python Dependencies
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install PySide6 first, then other dependencies
        # Pin PySide6 to match Qt version for consistency
        pip install pyside6==6.5.3
        # Install other dependencies from your project (adjust as needed)
        pip install molmass aqtinstall beautifulsoup4 bs4 certifi charset-normalizer defusedxml humanize idna patch py7zr requests semantic-version soupsieve typing-extensions urllib3

    # Step 5: Verify JSON config exists
    - name: Verify JSON config exists
      run: |
        if [ ! -f qt_for_python_android_deploy.json ]; then
          echo "ERROR: qt_for_python_android_deploy.json not found!"
          exit 1
        fi
        echo "qt_for_python_android_deploy.json found."
        cat qt_for_python_android_deploy.json

    # Step 6: Prepare Android Resources (Optional, if needed)
    - name: Prepare Android Resources
      run: |
        mkdir -p src/res/drawable # Ensure standard Android resource dirs exist if needed by JSON
        if [ -f "data/icon.png" ]; then
          cp data/icon.png src/res/drawable/icon.png # Example: Copy icon
          echo "Copied icon from data/icon.png to src/res/drawable/"
        else
          # Adjust this path/logic if your icon isn't in data/icon.png
          echo "Warning: data/icon.png not found. App might lack an icon."
        fi
        # Add commands here to copy other resources if your JSON references them

    # --- Environment Setup ---

    # Step 7a: Install Qt for Desktop (Host Tools)
    # We need qttools (containing androiddeployqt) for the host machine
    - name: Install Qt for Desktop (Host Tools)
      uses: jurplel/install-qt-action@v3
      id: install_qt_host
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        # *** REMOVED 'modules: qttools' - Tools are usually included by default ***
        cache: 'true'
        # Specify install directory to keep things organized
        dir: '${{ github.workspace }}/qt_host'

    # Step 7b: Install Qt for Android (Target Libraries)
    # We need qtbase libraries compiled for the Android target architecture
    - name: Install Qt for Android (Target Libraries)
      uses: jurplel/install-qt-action@v3
      id: install_qt_target
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'android'
        arch: 'android_arm64_v8a' # Choose target arch (arm64_v8a, armeabi_v7a, x86, x86_64)
        # Usually only need qtbase for the target device unless you use more modules
        modules: 'qtbase'
        cache: 'true'
        dir: '${{ github.workspace }}/qt_target'
        # IMPORTANT: Prevent this action from interfering with Python setup
        setup-python: 'false'

    # Step 8: Setup Android SDK components
    # Installs SDK, NDK, build-tools etc. and sets ANDROID_SDK_ROOT, ANDROID_NDK_ROOT
    - name: Setup Android SDK components
      uses: android-actions/setup-android@v3
      # This action sets up SDK/NDK based on defaults or project requirements.
      # Check its documentation if you need specific API levels or NDK versions.

    # Step 9: Run androiddeployqt
    - name: Run androiddeployqt
      env:
         # Point Qt6_DIR to the *target* Qt installation for androiddeployqt
         Qt6_DIR: ${{ github.workspace }}/qt_target/6.5.3/android_arm64_v8a
         # Add the *host* Qt bin directory (where androiddeployqt lives) to PATH
         PATH: ${{ github.workspace }}/qt_host/6.5.3/gcc_64/bin:$PATH
      run: |
        echo "--- Environment Variables ---"
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
        echo "Qt6_DIR=$Qt6_DIR"
        echo "Host Qt Tools Path: ${{ github.workspace }}/qt_host/6.5.3/gcc_64/bin"
        echo "Which androiddeployqt: $(which androiddeployqt || echo 'androiddeployqt not found in PATH')"
        ls -l ${{ github.workspace }}/qt_host/6.5.3/gcc_64/bin # Verify executable exists
        echo "--- Running androiddeployqt ---"

        # Verify androiddeployqt can be executed
        if ! command -v androiddeployqt &> /dev/null; then
            echo "ERROR: androiddeployqt command not found in PATH!"
            echo "PATH=$PATH"
            exit 1
        fi

        # Create output directory
        mkdir -p build-android

        # Run the deployment tool
        # androiddeployqt uses Qt6_DIR to find target libs and NDK/SDK roots from env
        androiddeployqt \
          --input qt_for_python_android_deploy.json \
          --output build-android \
          --android-platform android-33 `# Or latest stable, e.g., android-34. Must be >= minSdk` \
          --gradle \
          --verbose # Add verbose flag for more detailed output

        echo "--- androiddeployqt Finished ---"
        ls -lR build-android # Verify output directory contents recursively


    # Step 10: Build with Gradle
    - name: Build with Gradle
      working-directory: ./build-android
      run: |
        echo "--- Building with Gradle ---"
        # Ensure gradlew is executable
        chmod +x ./gradlew

        # Verify required env vars are set (should be by setup-android)
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
        # Check Java version Gradle will use
        ./gradlew --version

        # Run the Gradle build (use assembleRelease for release builds)
        # Use --info or --debug for more verbose Gradle output if needed
        ./gradlew assembleDebug --info

        echo "--- Gradle Build Finished ---"
        # List the output APKs for verification
        echo "Listing generated APKs:"
        find build/outputs/apk/debug/ -name "*.apk" -ls

    # Step 11: Upload APK artifact
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: MolarMass-Android-Debug-APK
        # Path to the generated APK(s)
        path: ./build-android/build/outputs/apk/debug/*.apk
        if-no-files-found: error # Fail the workflow if no APK is found
